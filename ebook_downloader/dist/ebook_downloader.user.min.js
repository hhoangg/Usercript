// @license         MIT
const selectByXpath=t=>document.evaluate(t,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;function createElementFromHTML(t){var e=document.createElement("template");return t=t.trim(),e.innerHTML=t,e.content}const storageKey={coverBlob:"coverBlob"};class azhTable{constructor(t={db:null,name:"",columns:[]}){if(!t.db)throw new Error("db not found in table");if(!t.name)throw new Error("Table missing name");if(!t.columns||!t.columns.length)throw new Error("Table column not defined.");this.db=t.db,this.name=t.name,t.columns.forEach((t=>{this.columns={...this.columns,[t.title]:{defaultValue:t.defaultValue}}})),this.tableIndex=`${this.db.getDbName()}__${this.name}`}db=null;name="";columns={};dataValue=null;tableIndex="";async _getAllKeyByName(t){return(await localforage.keys()).filter((e=>_.startsWith(e,t)))}async getAllKeysTable(){return this._getAllKeyByName(`${this.tableIndex}[`)}async createOrUpdate(t){t.id||(t.id=uniqid());const e={};Object.keys(t).forEach((o=>{this.columns[o]&&(e[o]=t[o])})),Object.keys(this.columns).forEach((t=>{void 0===e[t]&&void 0!==this.columns[t].defaultValue&&(e[t]=this.columns[t].defaultValue)}));const o=await localforage.getItem(`${this.tableIndex}[${t.id}]`);return o?this.update({where:{id:t.id}},e,o):(await localforage.setItem(`${this.tableIndex}[${t.id}]`,e),e)}async update(t,e,o){let n=o;if(!o||!o.id){n={...await this.findOne({where:t.where}),...n}}return n?(await localforage.setItem(`${this.tableIndex}[${n.id}]`,{...n,...e}),localforage.getItem(`${this.tableIndex}[${n.id}]`)):n}async bulkCreateOrUpdate(t){return Promise.all(t.map(this.createOrUpdate))}async findOne(t={where:{}}){this.dataValue=null;const e=await this.getAllKeysTable();if(!e.length)return this.dataValue;switch(!0){case!t||!t.where||!Object.keys(t.where).length:e[0]&&(this.dataValue=await localforage.getItem(e[0]));break;case!!t.where&&!!Object.keys(t.where).length:if(void 0!==typeof t.where.id&&null!==t.where.id)this.dataValue=await localforage.getItem(`${this.tableIndex}[${t.where.id}]`);else{const o=await Promise.all(e.map(localforage.getItem));this.dataValue=o.find((e=>this._compareObject(e,t.where)))}}return this.dataValue}_compareObject(t,e){const o=Object.keys(e);for(const n of o)if(e[n]!=t[n])return!1;return!0}async findAll(t={where:{}}){this.dataValue=[];const e=await this.getAllKeysTable();if(!e.length)return this.dataValue;switch(!0){case!t||!t.where||!Object.keys(t.where).length:this.dataValue=await Promise.all(e.map((t=>localforage.getItem(t))));break;case!!t.where&&!!Object.keys(t.where).length:if(void 0!==typeof t.where.id&&null!==t.where.id)_.isArray(t.where.id)?this.dataValue=await Promise.all(t.where.id.map((t=>localforage.getItem(`${this.tableIndex}[${t}]`)))):this.dataValue=[await localforage.getItem(`${this.tableIndex}[${t.where.id}]`)];else{const o=await Promise.all(e.map(localforage.getItem));this.dataValue=o.filter((e=>this._compareObject(e,t.where)))}}return this.dataValue}}class azhDb{constructor(t){this.dbName=t?`azhDb-${t}`:"azhDb"}models={};dbName="";async init(t=[]){const e=await localforage.getItem(this.dbName);return e?this._initTable(e.tables):(await localforage.setItem(this.dbName,{tables:t}),this._initTable(t)),this}_initTable(t){t.forEach((t=>{this.models[t.name]=new azhTable({db:this,name:t.name,columns:t.columns})}))}getDbName(){return this.dbName}getModel(t){return this.models[t]}getModels(){return this.models}}class BaseModel{constructor(t={}){Object.keys(t).forEach((e=>{this[e]=t[e]}))}btnDownload={position:"afterbegin",id:uniqid("btn-download-"),text:"Download",actionTarget:".azh-btn-download",className:{progress:".azh-download-progress",text:".azh-download-text",completed:".azh-download-completed"}};_METHOD_OVERWRITE=["getChapterId","init","getNextChapUrl","getContentOnChap","getTitleOnChap","getFirstChapUrl"];jepub=new jEpub;delayPerChap=100;pageName=document.title;pathname=location.pathname;chapTitle="";endDownload=!1;ebookTitle="";ebookAuthor="";ebookCover="";ebookDesc="";ebookType=[];ebookStatus="release";host=location.host;referrer=location.protocol+"//"+this.host+this.pathname;ebookFilename=this.pathname.slice(8,-1)+".epub";credits="";endChapter=0;$btnDownload;$btnText;ebookId;$btnProgress;coverBlob;db=new azhDb;getAreaBtn(){return document.body}makeBtnDownload(){const t=document.createElement("button");return t.innerText=this.btnDownload.text,t.id=this.btnDownload.id,t}addBtnToArea(){const t=this.getAreaBtn(),e=this.makeBtnDownload();return e.id=uniqid("azh-download-button-"),t.insertAdjacentHTML(this.btnDownload.position,e.outerHTML),document.querySelector(`#${e.id} ${this.btnDownload.actionTarget||""}`)}async createStory(){const{Book:t}=this.db.getModels(),e=await t.findOne({where:{id:this.ebookId}});let o={id:this.ebookId,name:this.ebookTitle,author:this.ebookAuthor,cover:this.coverBlob,type:this.ebookType,total_chap:this.endChapter,status:this.ebookStatus};return e&&(o={...e,...o,...e.cover&&{cover:e.cover}}),t.createOrUpdate(o)}async _init(){this.init(),this.jepub.init({title:this.ebookTitle,author:this.ebookAuthor,publisher:this.host,description:this.ebookDesc,tags:this.ebookType}).uuid(this.referrer).notes(this.credits),this.db=await this.db.init([{name:"Book",columns:[{title:"id",defaultValue:"Unknown"},{title:"name",defaultValue:"Unknown"},{title:"author",defaultValue:"Unknown"},{title:"cover",defaultValue:null},{title:"type",defaultValue:[]},{title:"total_chap",defaultValue:0},{title:"total_chap_downloaded",defaultValue:0},{title:"status",defaultValue:"release"},{title:"created_at",defaultValue:new Date}]},{name:"Chapter",columns:[{title:"id",defaultValue:"Unknown",dataType:"string"},{title:"title",defaultValue:"Unknown",dataType:"string"},{title:"content",defaultValue:null,dataType:"string"},{title:"order",defaultValue:0,dataType:"number"},{title:"book_id",defaultValue:null,dataType:"string"}]}]);const t=await this.createStory();t.cover&&!this.coverBlob&&this._setCoverBlob(t.cover)}_updateStory(t){const{Book:e}=this.db.getModels();return e.update({where:{id:this.ebookId}},t)}_createChapter(t){const{Chapter:e}=this.db.getModels();return e.createOrUpdate(t)}_getChapterById(t){const{Chapter:e}=this.db.getModels();return e.findOne({where:{id:t}})}async _setCoverBlob(t){await this._updateStory({cover:t}),this.coverBlob=t,this.jepub.cover(t)}async _setEbookCover(t){this.ebookCover=t;const e=await this._downloadCover();await this._setCoverBlob(e)}_addChap(t={content:"",title:""}){this.jepub.add(t.title,t.content)}async _getChap(t){if(t){return(await axios({method:"GET",url:t})).data.match(/<body.*?>([\s\S]*)<\/body>/)[1]}return null}_updateBtnProgress(t){this.$btnProgress||(this.$btnProgress=this.$btnDownload.querySelector(this.btnDownload.className.progress)),this.$btnProgress.style.width=`${t}%`}_updateBtnText(t){this.$btnText||(this.$btnText=this.$btnDownload.querySelector(this.btnDownload.className.text)),this.$btnText.textContent=t}async _genEbook(){await this.jepub.generate("blob",(t=>{this._updateBtnText("compressing "+t.percent.toFixed(2)+"%")})).then((t=>{saveAs(t,this.ebookFilename)})).catch((function(t){console.error(t)}))}_onDownload=async()=>{let t;const e=prompt("You want to custom cover?");e&&await this._setEbookCover(e);let o=this.getFirstChapUrl();for(let e=1;e<=this.endChapter;e++){1!==e&&t&&(o=this.getNextChapUrl(t));const n=this.getChapterId(o),a=await this._getChapterById(n),r={...a,id:n,order:e,book_id:this.ebookId};if(!a){let t=await this._getChap(o);r.content=t}t=createElementFromHTML(r.content);const i=this.getTitleOnChap(t),s=this.getContentOnChap(t);this._addChap({content:s,title:i}),await this._createChapter({...r,title:i,id:n,order:e,book_id:this.ebookId});const l=e/this.endChapter*100;this._updateBtnText(`${l.toFixed(2)}%`),this._updateBtnProgress(l)}return this._updateBtnText("Completed"),this.$btnDownload.classList.add(this.btnDownload.className.completed.replace(".","")),this.$btnDownload.removeEventListener("click",this._onDownload),this._genEbook()};_raiseMissingMethod(t=""){throw new Error(`Method ${t} not found, plz make this method on your model.`)}_downloadCover(){if(this.ebookCover)return new Promise(((t,e)=>{GM.xmlHttpRequest({method:"GET",url:this.ebookCover,responseType:"arraybuffer",onload:o=>{try{return this.jepub.cover(o.response),t(o.response)}catch(t){return e(t)}},onerror:e})}))}async run(){for(const t of this._METHOD_OVERWRITE)if(!this[t])throw this._raiseMissingMethod(t);if(await this._init(),!this.coverBlob){const t=await this._downloadCover();await this._setCoverBlob(t)}this.$btnDownload=this.addBtnToArea(),this.$btnDownload.addEventListener("click",this._onDownload)}}const downloadButtonHTML='\n<div class="azh-btn-download">\n  <div class="azh-download-progress"></div>\n  <div class="azh-download-text">Download</div>\n  <div class="azh-download-progress-per-item"></div>\n</div>';function downloadButton(){const t=document.createElement("div");return t.classList.add("azh-theme-dark"),t.insertAdjacentHTML("afterbegin",downloadButtonHTML),t}class Ztruyen extends BaseModel{makeBtnDownload=downloadButton;init(){const t=document.querySelector(".story-box-top");this.btnDownload.position="beforeend",this.credits='<p>Truyện được tải từ <a href="'+this.referrer+'">ZTruyen</a></p><p>Userscript được viết bởi: <a href="https://azhoang.github.io/">azHoang</a></p>',this.ebookTitle=this.pageName.split("-")[0].trim(),this.ebookCover=t.querySelector(".container > .row > img").getAttribute("src"),document.querySelector(".detail-story .content-story > p").remove(),this.ebookDesc=document.querySelector(".detail-story .content-story").textContent.trim(),this.ebookType=[...this.selectValueByAttr("Thể loại").querySelectorAll("a")].map((t=>t.textContent.trim())),this.ebookAuthor=this.selectValueByAttr("Tác giả").textContent.trim(),this.endChapter=Number(this.selectValueByAttr("Số chương").textContent.trim().replace(/\W/g,"")),this.ebookId=this.pathname.split("/").slice(-1)[0],this.ebookStatus=this.selectValueByAttr("Trạng thái").textContent.trim()}selectValueByAttr(t){return selectByXpath(`//body/main//*/table/tbody/tr/td[text()='${t}']/../th`)}getAreaBtn(){return document.querySelector("body > main > div > div > div > div > div.text-gray-1.mt-3")}getNextChapUrl(t){const[,e]=t.querySelectorAll(".button-chapter a");return e?`${location.href}/${e.getAttribute("href")}`:null}getContentOnChap(t){return[...t.querySelectorAll(".content-block")].map((t=>t.outerHTML)).join("\n")}getChapterId(t){return t.split("/").slice(-1)[0]}getTitleOnChap(t){return t.querySelector(".title-chapter").textContent.trim()}getFirstChapUrl(){return selectByXpath("//body/main//button[text()='Đọc truyện']/../../a").getAttribute("href")}}class HdxTruyen extends BaseModel{makeBtnDownload=downloadButton;init(){this.btnDownload.position="afterbegin",this.credits='<p>Truyện được tải từ <a href="'+this.referrer+'">TruyenHdx</a></p><p>Userscript được viết bởi: <a href="https://azhoang.github.io/">azHoang</a></p>',this.ebookTitle=this.pageName.split("-")[0].trim(),this.ebookCover=document.querySelector(".book3dcenter > .book3d > img").dataset.src,this.ebookDesc=document.querySelector("#gioi_thieu .gioi_thieu").textContent.trim(),this.ebookType=this.pageName.split("-").slice(-1),this.ebookAuthor=this.pageName.split("-")[1].trim(),this.endChapter=Number(document.querySelector("#newchap .listchap li").textContent.trim().match(/Chương( ?\d+ ?)/gm)[0].match(/\d+/)[0]),this.ebookId=this.pathname.split("/").slice(-2)[0]}getAreaBtn(){return document.querySelector(".book3dcenter")}getNextChapUrl(t){const e=[...t.querySelectorAll(".next-chap")].slice(-1)[0].querySelector("a");return e?e.getAttribute("href"):null}getContentOnChap(t){return t.querySelector(".container.cpt.truyen .reading").innerHTML.trim()}getChapterId(t){return console.log(t),t.split("/").slice(-2)[0]}getTitleOnChap(t){return t.querySelector(".container.cpt.truyen .text-center:nth-child(2)").textContent.trim()}getFirstChapUrl(){const t=document.querySelector("#dsc .listchap li a");return 0===Number(t.textContent.trim().match(/Chương( ?\d+ ?)/gm)[0].match(/\d+/)[0])&&(this.endChapter+=1),console.log(this.endChapter),t.getAttribute("href")}}!function(){"use strict";const t={"ztruyen.vn":Ztruyen,"truyenhdx.com":HdxTruyen};if(!t[window.location.host])return alert("We not support this Ebook site. plz contact https://azhoang.github.io/"),window.open("https://azhoang.github.io/");const e=new t[window.location.host];if(!e.run)throw new Error('"run" funtion not defined.');e.run()}(),function(){const t=document.createElement("style");t.innerHTML="/* src/styles/download-button.css */\n.azh-theme-dark {\n  --primary: #d8baf0;\n  --success: #baf0c6;\n  --bg: #2c3436;\n  --bg-progress: linear-gradient(90deg, rgba(44, 52, 54, 1) 0%, rgba(9, 121, 70, 1) 49%, rgba(0, 255, 151, 1) 100%);\n  --bg-progress-item: linear-gradient(\n    90deg,\n    rgba(44, 54, 45, 1) 0%,\n    rgba(93, 121, 9, 1) 49%,\n    rgba(255, 186, 0, 1) 100%\n  );\n}\n/* Button */\n.azh-btn-download {\n  display: block!important;\n  background: var(--bg);\n  width: 200px;\n  position: relative;\n  color: var(--primary);\n  cursor: pointer;\n  text-align: center;\n  text-transform: capitalize;\n  border-radius: 7px;\n  font-weight: 600;\n  overflow: hidden;\n  border: none;\n  text-decoration: none;\n}\n.azh-btn-download[disabled] {\n  cursor: not-allowed;\n}\n.azh-download-text {\n  padding: 15px;\n}\n.azh-download-progress {\n  height: 100%;\n  background: var(--bg-progress);\n  position: absolute;\n  top: 0;\n  left: 0;\n  opacity: 0.4;\n}\n/* Button Complete */\n.azh-download-completed {\n  color: var(--success);\n  /* border-color: var(--success); */\n  /* cursor: not-allowed; */\n}\n.azh-download-progress-per-item {\n  height: 3px;\n  background: var(--bg-progress-item);\n  position: absolute;\n  left: 0;\n  bottom: 0;\n}\n\n/* src/styles/ztruyen-download-button.css */\n.azh-theme-dark {\n  --primary: #d8baf0;\n  --success: #baf0c6;\n  --bg: #2c3436;\n  --bg-progress: #71777d;\n  display: inline-flex;\n}\n/* Button */\n.azh-btn-download {\n  color: #ffc008;\n  border-radius: 20px;\n  padding: 8.5px 50px;\n  margin-left: 0.5rem;\n  width: auto;\n}\n\n.azh-btn-download:hover{\n  background-color: #71777d;\n}\n\n.azh-btn-download[disabled] {\n  cursor: not-allowed;\n}\n.azh-download-text {\n  padding: unset;\n}\n.azh-download-progress {\n  background: linear-gradient(90deg, rgba(44, 52, 54, 1) 0%, rgba(9, 121, 70, 1) 49%, rgba(0, 255, 151, 1) 100%);\n}\n/* Button Complete */\n.azh-download-completed {\n  color: var(--success);\n}\n\n/* src/styles/truyenhdx-download-button.css */\n.azh-btn-download {\n  width: 180px;\n  border-radius: 5px;\n  margin-bottom: 1rem;\n  margin-left: 0;\n}\n",document.body.appendChild(t)}();
